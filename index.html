<!DOCTYPE html>
<html lang="fr">
<head>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://zivhvacygphmdhbsjonr.supabase.co";       // colle ton URL
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inppdmh2YWN5Z3BobWRoYnNqb25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1OTY0ODYsImV4cCI6MjA4MTE3MjQ4Nn0.9g17ZI3D5x4onq7ud6zgosDucyrrzQDHNwYrsiSaWqA";       // colle ton anon key
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BadgeLife</title>
  <meta name="theme-color" content="#0b1220">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/badgelife-logo.svg">
  <link rel="icon" href="icons/badgelife-logo.svg" type="image/svg+xml">
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #1f2937;
      --accent: #22d3ee;
      --accent2: #a78bfa;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --success: #22c55e;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(34,211,238,0.08), transparent 30%),
                  radial-gradient(circle at 80% 10%, rgba(167,139,250,0.12), transparent 35%),
                  #0b1220;
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 22px 5vw 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    h1 {
      margin: 0;
      font-size: 26px;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0.5px;
    }
    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: none;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #192132;
      color: var(--text);
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 13px;
    }
    main {
      padding: 0 5vw 40px;
      max-width: 960px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .card {
      background: linear-gradient(135deg, rgba(17,24,39,0.95), rgba(17,24,39,0.85));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.35);
    }
    .section-title {
      margin: 0 0 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.4px;
      font-size: 14px;
    }
    .hero {
      background: linear-gradient(135deg, rgba(34,211,238,0.15), rgba(167,139,250,0.12));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 18px;
      box-shadow: none;
      margin-bottom: 18px;
    }
    .hero h2 { margin: 0 0 8px; font-size: 24px; }
    .hero p { margin: 0 0 12px; color: var(--muted); }
    .hidden { display: none; }
    .mini-note { font-size: 13px; color: var(--muted); }
    .pill-strong {
      display: inline-flex;
      align-items: center;
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      font-weight: 800;
      font-size: 20px;
      letter-spacing: 0.2px;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: #0d1422;
      color: var(--text);
      font-size: 15px;
    }
    textarea { resize: vertical; min-height: 80px; }
    button {
      background: #1f2a3d;
      color: var(--text);
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.2s;
      box-shadow: none;
    }
    button:hover { transform: translateY(-1px) scale(1.01); }
    button:active { transform: translateY(0); }
    .ghost {
      background: transparent;
      color: var(--text);
      border: 1px dashed rgba(255,255,255,0.2);
      box-shadow: none;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }
    .mini-card {
      background: #0d1422;
      border: 1px solid rgba(255,255,255,0.07);
      padding: 12px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: border-color 0.15s ease, background 0.2s ease;
    }
    .mini-card.open {
      border-color: rgba(34,211,238,0.35);
      background: #131c2b;
    }
    .badge-header {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      user-select: none;
    }
    .mini-card h4 { margin: 0; }
    .mini-card p { margin: 0; color: var(--muted); line-height: 1.4; }
    .b-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: #1b2435;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
      font-size: 16px;
      flex-shrink: 0;
    }
    .chevron {
      margin-left: auto;
      color: var(--muted);
      transition: transform 0.18s ease;
      font-size: 14px;
    }
    .mini-card.open .chevron {
      transform: rotate(90deg);
    }
    .tab-header {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }
    .chevron-tab {
      margin-left: auto;
      color: var(--muted);
      transition: transform 0.18s ease;
      font-size: 14px;
    }
    .section-block.open .chevron-tab {
      transform: rotate(90deg);
    }
    .tab-body { margin-top: 8px; }
    .pill {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-size: 12px;
      gap: 6px;
      align-items: center;
    }
    .status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 13px;
    }
    .ok { background: rgba(34,197,94,0.15); color: var(--success); border: 1px solid rgba(34,197,94,0.3); }
    .ko { background: rgba(239,68,68,0.15); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }
    .note { color: var(--muted); font-size: 14px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .tag { color: var(--accent); font-weight: 700; }
    .list { display: flex; flex-direction: column; gap: 8px; }
    .progress {
      height: 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 999px;
      overflow: hidden;
    }
    .progress span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      width: 0;
      transition: width 0.25s ease;
    }
    .stat-card {
      background: #0d1422;
      border: 1px solid rgba(255,255,255,0.07);
      border-radius: 10px;
      padding: 10px 12px;
    }
    .stat-card h4 { margin: 0; font-size: 15px; }
    .stat-card p { margin: 4px 0 0; color: var(--muted); font-size: 13px; }
    .tabs {
      display: flex;
      gap: 8px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    .tab-btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: #0d1422;
      color: var(--text);
      cursor: pointer;
      font-weight: 700;
      transition: all 0.15s ease;
    }
    .tab-btn:hover { border-color: rgba(34,211,238,0.35); }
    .tab-btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #0b1220;
      border-color: transparent;
      box-shadow: 0 8px 18px rgba(34,211,238,0.25);
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    @media (max-width: 720px) {
      header { flex-direction: column; align-items: flex-start; }
      main { padding: 0 20px 30px; }
    }
  </style>
</head>
<body>
  <header>
    <h1><span class="dot"></span> BadgeLife </h1>
    <div class="badge">Cr√©e ton profil ‚Ä¢ Collectionne des badges</div>
  </header>

  <main id="app-container">
    <section class="hero" id="landing">
      <h2>BadgeLife</h2>
      <p>Cr√©e un compte, connecte-toi et collectionne des badges. Tes donn√©es restent sur cet appareil.</p>
      <div class="row">
        <button id="btn-login">Connexion</button>
        <button id="btn-register" class="ghost">S'inscrire</button>
      </div>
      <div id="login-form" class="hidden" style="margin-top:12px;">
        <div class="row">
          <input id="login-user" placeholder="Nom d'utilisateur" />
          <input id="login-pass" type="password" placeholder="Mot de passe" />
          <button id="login-submit">Se connecter</button>
        </div>
      </div>
      <div id="register-form" class="hidden" style="margin-top:12px;">
        <div class="row">
          <input id="reg-user" placeholder="Nom d'utilisateur" />
          <input id="reg-first" placeholder="Pr√©nom" />
          <input id="reg-last" placeholder="Nom" />
          <input id="reg-pass" type="password" placeholder="Mot de passe" />
          <button id="reg-submit">Valider l'inscription</button>
        </div>
        <p class="mini-note">Les comptes sont stock√©s en local sur cet appareil.</p>
      </div>
    </section>

    <section class="card hidden" id="app-shell">
    <section class="card">
      <h3 class="section-title">Profil</h3>
      <div class="row">
        <span id="profile-name-display" class="pill-strong">Profil non d√©fini</span>
        <button id="logout" class="ghost">D√©connexion</button>
        <button id="reset-data" class="ghost">R√©initialiser</button>
      </div>
      <p id="hello" style="margin-top:8px;font-weight:700;">Bienvenue !</p>
      <p id="profile-meta" class="note" style="margin-top:4px;"></p>

      <div id="profile-stats" class="grid" style="margin-top:10px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));"></div>

      <div style="border-top:1px solid rgba(255,255,255,0.07); margin:14px 0;"></div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="tab-profiles">Autres profils</button>
        <button class="tab-btn" data-tab="tab-mine">Mes badges</button>
        <button class="tab-btn" data-tab="tab-all">Tous les badges</button>
      </div>

      <div id="tab-profiles" class="tab-panel active">
        <h3 class="section-title">Autres profils</h3>
        <div class="list">
          <p class="note">Bient√¥t : ici s‚Äôafficheront d‚Äôautres profils si cr√©√©s.</p>
        </div>
      </div>

      <div id="tab-mine" class="tab-panel">
        <div class="section-block open" id="my-section">
          <div class="tab-header" id="toggle-my">
            <h3 class="section-title" style="margin:0;">Mes badges</h3>
            <span class="chevron-tab">‚ñ∏</span>
          </div>
          <div class="tab-body" id="my-body">
            <div id="my-badges" class="list"></div>
          </div>
        </div>
      </div>

      <div id="tab-all" class="tab-panel">
        <div class="section-block open" id="all-section">
          <div class="tab-header" id="toggle-all">
            <h3 class="section-title" style="margin:0;">Tous les badges</h3>
            <span class="chevron-tab">‚ñ∏</span>
          </div>
          <div class="tab-body" id="all-body">
            <div class="grid" id="all-badges"></div>
          </div>
        </div>
      </div>

    </section>
  </main>

  <script>
    // Stockage local pour retenir le profil et les badges
    const state = {
      profiles: [],
      currentUser: '',
      name: '',
      firstName: '',
      lastName: '',
      owned: {},
      answers: {},
      started: false
    };

    const allBadges = [
      { id: 'globe', title: 'Globe Trotter', icon: 'üåç', hint: '3 niveaux selon ton nombre de pays visit√©s.', render: renderGlobe },
      { id: 'voyageur', title: 'Voyageur', icon: 'üß≠', hint: '5 niveaux: plus tu as pris de transports diff√©rents, plus tu montes en niveaux.', render: renderVoyageur },
      { id: 'militaire', title: 'Militaire', icon: 'üõ°Ô∏è', hint: 'D√©clare si tu as termin√© ton service civil.', render: renderMilitaire },
      { id: 'diplome', title: 'Dipl√¥m√©', icon: 'üéì', hint: '5 niveaux: CFC, Matu, Bachelor, Master, Doctorat.', render: renderDiplome },
      { id: 'influence', title: 'Influenceur', icon: 'üì£', hint: '5 niveaux selon tes abonn√©s.', render: renderInfluence },
      { id: 'chanceux', title: 'Chanceux', icon: 'üçÄ', hint: '5 niveaux selon tes gains.', render: renderChanceux },
      { id: 'fan', title: 'Fanatique', icon: 'üéµ', hint: '5 niveaux selon tes concerts visit√©s.', render: renderFan },
      { id: 'entrepreneur', title: 'Entrepreneur', icon: 'üöÄ', hint: '1 niveau: avoir mont√© une entreprise.', render: renderEntrepreneur },
      { id: 'lecteur', title: 'Lecteur', icon: 'üìö', hint: '5 niveaux selon le nombre de livres lus.', render: renderLecteur },
      { id: 'cuisto', title: 'Cuisto', icon: 'üç≥', hint: '1 niveau: avoir cuisin√© pour 10+ personnes.', render: renderCuisto },
      { id: 'million', title: 'Millionnaire', icon: 'üí∞', hint: '1 niveau: avoir plus de 1 million sur son compte.', render: renderMillion },
      { id: 'geek', title: 'Geek', icon: 'üéÆ', hint: '3 niveaux selon les heures pass√©es sur un jeu.', render: renderGeek },
      { id: 'pilote', title: 'Pilote', icon: '‚úàÔ∏è', hint: '7 niveaux selon tes permis.', render: renderPilote },
      { id: 'killer', title: 'Killer', icon: '‚ò†Ô∏è', hint: '2 niveaux: animal, humain.', render: renderKiller },
      { id: 'voleur', title: 'Voleur', icon: 'üï∂Ô∏è', hint: '4 niveaux selon le montant vol√©.', render: renderVoleur },
      { id: 'donateur', title: 'Donateur', icon: 'ü§ù', hint: '4 niveaux selon tes dons.', render: renderDonateur },
      { id: 'fou', title: 'Fou du volant', icon: 'üöó', hint: '4 niveaux selon ta vitesse maximale sur autoroute.', render: renderFouVolant },
      { id: 'peintre', title: 'Artiste Peintre', icon: 'üé®', hint: '2 niveaux: avoir peint, puis vendu un tableau.', render: renderPeintre },
      { id: 'magnat', title: 'Magnat', icon: 'üè¶', hint: '4 niveaux selon l‚Äôargent sur ton compte.', render: renderMagnat },
      { id: 'kama', title: 'Kamasutra', icon: 'üíã', hint: '4 niveaux selon le nombre de positions pratiqu√©es.', render: renderKama },
      { id: 'body', title: 'Bodycounter', icon: 'üî•', hint: '6 niveaux selon le nombre de partenaires.', render: renderBody },
      { id: 'musicien', title: 'Musicien', icon: 'üé∏', hint: '1 niveau: avoir compos√© une musique.', render: renderMusicien },
      { id: 'polyglotte', title: 'Polyglotte', icon: 'üó£Ô∏è', hint: '5 niveaux selon le nombre de langues parl√©es.', render: renderPolyglotte },
      { id: 'cine', title: 'Cin√©phile', icon: 'üé¨', hint: '4 niveaux selon le nombre de films vus.', render: renderCine },
      { id: 'rando', title: 'Randonneur', icon: 'ü•æ', hint: '3 niveaux selon le nombre de sommets mont√©s.', render: renderRando },
      { id: 'codeur', title: 'Codeur', icon: 'üíª', hint: '5 niveaux selon tes heures de code.', render: renderCodeur },
      { id: 'jardinier', title: 'Jardinier', icon: 'üå±', hint: '3 niveaux selon le nombre de plantes que tu as fait pousser.', render: renderJardinier },
      { id: 'marathon', title: 'Marathonien', icon: 'üèÖ', hint: '4 niveaux selon ta plus longue course.', render: renderMarathon },
      { id: 'photo', title: 'Photographe', icon: 'üì∑', hint: '2 niveaux: prendre puis vendre une photo.', render: renderPhoto },
      { id: 'brasseur', title: 'Brasseur', icon: 'üç∫', hint: '3 niveaux selon le nombre de bi√®res diff√©rentes d√©gust√©es.', render: renderBrasseur },
      { id: 'sauveteur', title: 'Sauveteur', icon: '‚õëÔ∏è', hint: '1 niveau: avoir secouru une vie.', render: renderSauveteur },
      { id: 'parachute', title: 'Parachutiste', icon: 'ü™Ç', hint: '2 niveaux: premier saut, puis 5+ sauts.', render: renderParachute },
      { id: 'astro', title: 'Astronome', icon: 'üî≠', hint: '4 niveaux selon tes nuits d‚Äôobservation.', render: renderAstro },
      { id: 'volontaire', title: 'Volontaire', icon: 'ü§≤', hint: '3 niveaux selon tes heures de b√©n√©volat.', render: renderVolontaire },
      { id: 'dj', title: 'DJ', icon: 'üéß', hint: '3 niveaux selon le nombre de mixes jou√©s.', render: renderDJ },
      { id: 'gourmet', title: 'Gourmet', icon: 'üçΩÔ∏è', hint: '4 niveaux selon les restos √©toil√©s visit√©s.', render: renderGourmet },
      { id: 'contact', title: 'Contact', icon: 'üìá', hint: '5 niveaux selon le nombre de contacts sur ton t√©l√©phone.', render: renderContact },
      { id: 'amour', title: 'Amoureux/se', icon: '‚ù§Ô∏è', hint: '1 niveau: √™tre tomb√© amoureux au moins une fois.', render: renderAmour },
      { id: 'trompeur', title: 'Trompeur/se', icon: '‚ö†Ô∏è', hint: '1 niveau: avoir tromp√© une fois.', render: renderTrompeur },
      { id: 'accro', title: 'Accro', icon: '‚òï', hint: '6 niveaux: niveau baisse selon tes addictions d√©clar√©es.', render: renderAccro }
    ];

    const hello = document.getElementById('hello');
    const profileMeta = document.getElementById('profile-meta');
    const statsBox = document.getElementById('profile-stats');
    const nameDisplay = document.getElementById('profile-name-display');
    const resetBtn = document.getElementById('reset-data');
    const myBadges = document.getElementById('my-badges');
    const allBadgesContainer = document.getElementById('all-badges');
    const mySection = document.getElementById('my-section');
    const myBody = document.getElementById('my-body');
    const toggleMy = document.getElementById('toggle-my');
    const allSection = document.getElementById('all-section');
    const allBody = document.getElementById('all-body');
    const toggleAll = document.getElementById('toggle-all');
    const landing = document.getElementById('landing');
    const appShell = document.getElementById('app-shell');
    const loginBtn = document.getElementById('btn-login');
    const registerBtn = document.getElementById('btn-register');
    const loginForm = document.getElementById('login-form');
    const regForm = document.getElementById('register-form');
    const regUser = document.getElementById('reg-user');
    const regFirst = document.getElementById('reg-first');
    const regLast = document.getElementById('reg-last');
    const regPass = document.getElementById('reg-pass');
    const regSubmit = document.getElementById('reg-submit');
    const loginUser = document.getElementById('login-user');
    const loginPass = document.getElementById('login-pass');
    const loginSubmit = document.getElementById('login-submit');
    const logoutBtn = document.getElementById('logout');
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabPanels = document.querySelectorAll('.tab-panel');


    function saveProfiles() {
      localStorage.setItem('badgeProfiles', JSON.stringify(state.profiles));
      localStorage.setItem('badgeCurrentUser', state.currentUser);
    }

    function loadProfiles() {
      state.profiles = JSON.parse(localStorage.getItem('badgeProfiles') || '[]');
      state.currentUser = localStorage.getItem('badgeCurrentUser') || '';
    }

    function applyProfile(p) {
      state.name = p.name || '';
      state.firstName = p.firstName || '';
      state.lastName = p.lastName || '';
      state.owned = p.owned || {};
      state.answers = p.answers || {};
      nameDisplay.textContent = state.name || 'Profil non d√©fini';
    }

    async function hashText(t) {
      const enc = new TextEncoder().encode(t);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    function persist() {
      if (state.currentUser) {
        const idx = state.profiles.findIndex(u => u.user === state.currentUser);
        if (idx >= 0) {
          state.profiles[idx] = {
            ...state.profiles[idx],
            name: state.name,
            firstName: state.firstName,
            lastName: state.lastName,
            owned: state.owned,
            answers: state.answers
          };
        } else {
          state.profiles.push({
            user: state.currentUser,
            name: state.name,
            firstName: state.firstName,
            lastName: state.lastName,
            owned: state.owned,
            answers: state.answers
          });
        }
      }
      saveProfiles();
      updateVisibility();
    }

    function refreshHello() {
      hello.textContent = state.name ? `Bonjour ${state.name} !` : 'Bienvenue !';
      profileMeta.textContent = state.name ? '' : 'Inscris-toi pour commencer.';
    }

    function addOwned(id, level = 1, { force = false, meta } = {}) {
      if (force) {
        state.owned[id] = level;
      } else {
        // Garde le plus haut niveau obtenu
        state.owned[id] = Math.max(state.owned[id] || 0, level);
      }
      if (meta !== undefined) {
        state.answers[id] = meta;
      }
      persist();
      renderOwned();
      renderAll();
    }

    function computeStats() {
      const ownedIds = Object.keys(state.owned);
      const totalOwned = ownedIds.length;
      const levelsSum = ownedIds.reduce((s,id)=> s + (state.owned[id]||0), 0);
      const multiOwned = ownedIds.filter(id => badgeMaxLevel(id) > 1).length;
      const multiTotal = allBadges.filter(b => badgeMaxLevel(b.id) > 1).length;
      const singleTotal = allBadges.filter(b => badgeMaxLevel(b.id) === 1).length;
      const singleOwned = ownedIds.filter(id => badgeMaxLevel(id) === 1).length;
      return { totalOwned, levelsSum, multiOwned, multiTotal, singleOwned, singleTotal };
    }

    function renderStats() {
      const { totalOwned, levelsSum, multiOwned, multiTotal, singleOwned, singleTotal } = computeStats();
      statsBox.innerHTML = '';
      const cards = [
        { title: 'Badges obtenus', desc: `${totalOwned} / ${allBadges.length}` },
        { title: 'Badges √† niveaux', desc: `${multiOwned} / ${multiTotal}` },
        { title: 'Badges uniques', desc: `${singleOwned} / ${singleTotal}` },
        { title: 'Niveaux cumul√©s', desc: `${levelsSum}` }
      ];
      cards.forEach(c => {
        const div = document.createElement('div');
        div.className = 'stat-card';
        div.innerHTML = `<h4>${c.title}</h4><p>${c.desc}</p>`;
        statsBox.appendChild(div);
      });
    }

    function updateVisibility() {
      if (state.started) {
        landing.classList.add('hidden');
        appShell.classList.remove('hidden');
      } else {
        landing.classList.remove('hidden');
        appShell.classList.add('hidden');
      }
    }

    function renderOwned() {
      myBadges.innerHTML = '';
      const entries = Object.keys(state.owned);
      if (!entries.length) {
        myBadges.innerHTML = '<p class="note">Aucun badge pour l‚Äôinstant. Lance-toi !</p>';
        renderStats();
        return;
      }
      entries.forEach(id => {
        const badge = allBadges.find(b => b.id === id);
        const level = state.owned[id];
        const row = document.createElement('div');
        row.className = 'mini-card';
        const maxLevel = badgeMaxLevel(badge.id);
        const header = document.createElement('div');
        header.className = 'badge-header';
        header.innerHTML = `
          <span class="b-icon">${badge.icon || '‚≠ê'}</span>
          <div>
            <h4 style="margin:0;">${badge.title}</h4>
            ${maxLevel > 1 ? `<span class="pill">Niveau ${level} / ${maxLevel}</span>` : ''}
          </div>
          <span class="chevron">‚ñ∏</span>
        `;
        const detail = document.createElement('div');
        detail.style.display = 'none';
        const answer = state.answers[id] !== undefined ? state.answers[id] : 'Aucune r√©ponse enregistr√©e pour le moment.';
        detail.innerHTML = `<p class="note" style="margin:6px 0 0;">${answer}</p>`;
        header.onclick = () => {
          const open = detail.style.display === 'none';
          detail.style.display = open ? 'block' : 'none';
          row.classList.toggle('open', open);
        };
        row.append(header, detail);
        myBadges.appendChild(row);
      });
      renderStats();
    }

    function badgeMaxLevel(id) {
      if (id === 'globe') return 3;
      if (id === 'voyageur') return 5;
      if (id === 'diplome') return 5;
      if (id === 'influence') return 5;
      if (id === 'chanceux') return 5;
      if (id === 'fan') return 5;
      if (id === 'lecteur') return 5;
      if (id === 'geek') return 3;
      if (id === 'pilote') return 7;
      if (id === 'voleur') return 4;
      if (id === 'donateur') return 4;
      if (id === 'fou') return 4;
      if (id === 'peintre') return 2;
      if (id === 'magnat') return 4;
      if (id === 'kama') return 4;
      if (id === 'body') return 6;
      if (id === 'killer') return 2;
      if (id === 'polyglotte') return 5;
      if (id === 'cine') return 4;
      if (id === 'rando') return 3;
      if (id === 'codeur') return 5;
      if (id === 'jardinier') return 3;
      if (id === 'marathon') return 4;
      if (id === 'photo') return 2;
      if (id === 'brasseur') return 3;
      if (id === 'sauveteur') return 1;
      if (id === 'parachute') return 2;
      if (id === 'astro') return 4;
      if (id === 'volontaire') return 3;
      if (id === 'dj') return 3;
      if (id === 'gourmet') return 4;
      if (id === 'contact') return 5;
      if (id === 'accro') return 6;
      return 1;
    }

    function renderAll() {
      allBadgesContainer.innerHTML = '';
      let openDetail = null;
      let openCard = null;
      allBadges.forEach(badge => {
        const card = document.createElement('div');
        card.className = 'mini-card';
        const statusLevel = state.owned[badge.id] || 0;
        const maxLevel = badgeMaxLevel(badge.id);
        const percent = Math.min((statusLevel / maxLevel) * 100, 100);
        const header = document.createElement('div');
        header.className = 'badge-header';
        header.innerHTML = `
          <span class="b-icon">${badge.icon || '‚≠ê'}</span>
          <div>
            <h4 style="margin:0;">${badge.title}</h4>
          </div>
          <span class="chevron">‚ñ∏</span>
        `;
        const detail = document.createElement('div');
        detail.style.display = 'none';
        detail.innerHTML = `
          <p style="margin:4px 0 6px;" class="note">${badge.hint}</p>
          <div class="row" style="margin-top:4px;">
            <span class="pill">Progression</span>
            <div class="progress" style="flex:1;"><span style="width:${percent}%;"></span></div>
            ${maxLevel > 1 ? `<span class="note">Niv ${statusLevel || 0}</span>` : ''}
          </div>
          <div class="list" id="zone-${badge.id}"></div>
        `;
        header.onclick = () => {
          if (openDetail && openDetail !== detail) {
            openDetail.style.display = 'none';
            openCard?.classList.remove('open');
          }
          const nowOpen = detail.style.display === 'none';
          detail.style.display = nowOpen ? 'block' : 'none';
          if (nowOpen) {
            openDetail = detail;
            openCard = card;
            card.classList.add('open');
          } else {
            openDetail = null;
            openCard = null;
            card.classList.remove('open');
          }
        };
        card.append(header, detail);
        allBadgesContainer.appendChild(card);
        badge.render(detail.querySelector(`#zone-${badge.id}`), statusLevel, addOwned);
      });
    }

    function setupToggle(headerEl, bodyEl, blockEl) {
      headerEl.onclick = () => {
        const isOpen = bodyEl.style.display !== 'none';
        bodyEl.style.display = isOpen ? 'none' : 'block';
        blockEl.classList.toggle('open', !isOpen);
      };
      // default open
      bodyEl.style.display = 'block';
      blockEl.classList.add('open');
    }

    // --- Badge 1 : Globe Trotter ---
    function renderGlobe(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = '√âcris les pays que tu as d√©j√† visit√©s (s√©pare par une virgule). 3 niveaux cach√©s.';
      const area = document.createElement('textarea');
      area.placeholder = 'Exemple: France, Espagne, Italie...';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const countries = area.value.split(',').map(v => v.trim()).filter(Boolean);
        const count = countries.length;
        // Seuils cach√©s : 4+, 11+, 26+
        let newLevel = 0;
        if (count >= 26) newLevel = 3;
        else if (count >= 11) newLevel = 2;
        else if (count >= 4) newLevel = 1;
        if (newLevel > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${newLevel} obtenu (${count} pays)</span>`;
          onGain('globe', newLevel, { meta: `${count} pays visit√©s` });
        } else {
          status.innerHTML = `<span class="status ko">Encore un peu de voyages (${count} pays)</span>`;
        }
      };
      el.append(note, area, btn, status);
    }

    // --- Badge 2 : Militaire ---
    function renderMilitaire(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'As-tu termin√© ton service civil ?';
      const row = document.createElement('div');
      row.className = 'row';
      const yes = document.createElement('button');
      yes.textContent = 'Oui';
      const no = document.createElement('button');
      no.className = 'ghost';
      no.textContent = 'Non';
      const status = document.createElement('div');
      status.className = 'note';
      yes.onclick = () => {
        status.innerHTML = '<span class="status ok">Badge gagn√©</span>';
        onGain('militaire', 1, { meta: 'Service civil termin√©' });
      };
      no.onclick = () => {
        status.innerHTML = '<span class="status ko">Reviens quand ce sera fait</span>';
      };
      row.append(yes, no);
      el.append(note, row, status);
    }

    // --- Badge 3 : Voyageur √† niveaux ---
    function renderVoyageur(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = '5 niveaux : plus tu coches de transports diff√©rents, plus tu montes de niveaux.';
      const transports = [
        {id:'voiture', label:'Voiture'},
        {id:'bus', label:'Bus'},
        {id:'metro', label:'M√©tro'},
        {id:'train', label:'Train'},
        {id:'avion', label:'Avion'},
        {id:'bateau', label:'Bateau'},
        {id:'velo', label:'V√©lo'},
        {id:'covoit', label:'Covoiturage'},
        {id:'trott', label:'Trottinette'},
        {id:'telepherique', label:'T√©l√©ph√©rique'},
        {id:'helico', label:'H√©licopt√®re'}
      ];
      const list = document.createElement('div');
      list.className = 'list';
      const checks = {};
      transports.forEach(t => {
        const row = document.createElement('label');
        row.className = 'row';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = t.id;
        checks[t.id] = input;
        row.append(input, document.createTextNode(t.label));
        list.appendChild(row);
      });
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const chosen = transports.filter(t => checks[t.id].checked).map(t => t.id);
        const count = chosen.length;
        // Seuils par nombre de transports pris
        let newLevel = 0;
        if (count >= 11) newLevel = 5;
        else if (count >= 9) newLevel = 4;
        else if (count >= 7) newLevel = 3;
        else if (count >= 5) newLevel = 2;
        else if (count >= 3) newLevel = 1;

        if (newLevel >= 1) {
          status.innerHTML = `<span class="status ok">Niveau ${newLevel} obtenu (${count} transports)</span>`;
          onGain('voyageur', newLevel, { meta: `${count} transports` });
        } else {
          status.innerHTML = '<span class="status ko">Coche au moins 3 transports pour commencer</span>';
        }
      };
      el.append(note, list, btn, status);
    }

    // --- Badge Dipl√¥m√© (5 niveaux) ---
    function renderDiplome(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Choisis le plus haut dipl√¥me obtenu.';
      const select = document.createElement('select');
      const options = [
        { label: 'Aucun pour le moment', value: 0 },
        { label: 'CFC', value: 1 },
        { label: 'Maturit√©', value: 2 },
        { label: 'Bachelor', value: 3 },
        { label: 'Master', value: 4 },
        { label: 'Doctorat', value: 5 },
      ];
      options.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.label;
        select.appendChild(opt);
      });
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const val = Number(select.value);
        const label = options.find(o => o.value === val)?.label || '';
        if (val > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${val} obtenu</span>`;
          onGain('diplome', val, { meta: label });
        } else {
          status.innerHTML = '<span class="status ko">S√©lectionne ton dipl√¥me</span>';
        }
      };
      el.append(note, select, btn, status);
    }

    // --- Badge Influenceur (5 niveaux) ---
    function renderInfluence(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Entre ton nombre d‚Äôabonn√©s.';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 1200';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 10000) lvl = 5;
        else if (n >= 2000) lvl = 4;
        else if (n >= 1000) lvl = 3;
        else if (n >= 500) lvl = 2;
        else if (n >= 100) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} abonn√©s)</span>`;
          onGain('influence', lvl, { meta: `${n} abonn√©s` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 100 abonn√©s pour le niveau 1</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Amoureux/se (1 niveau) ---
    function renderAmour(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'As-tu d√©j√† √©t√© amoureux(se) au moins une fois ?';
      const btn = document.createElement('button');
      btn.textContent = 'Oui';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        status.innerHTML = '<span class="status ok">Badge obtenu</span>';
        onGain('amour', 1, { meta: 'D√©j√† √©t√© amoureux/se' });
      };
      el.append(note, btn, status);
    }

    // --- Badge Trompeur/se (1 niveau) ---
    function renderTrompeur(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'As-tu d√©j√† tromp√© une fois ?';
      const row = document.createElement('div');
      row.className = 'row';
      const yes = document.createElement('button');
      yes.textContent = 'Oui';
      const no = document.createElement('button');
      no.className = 'ghost';
      no.textContent = 'Non';
      const status = document.createElement('div');
      status.className = 'note';
      yes.onclick = () => {
        status.innerHTML = '<span class="status ok">Badge obtenu</span>';
        onGain('trompeur', 1, { meta: 'A d√©j√† tromp√©' });
      };
      no.onclick = () => {
        status.innerHTML = '<span class="status ko">Badge non obtenu</span>';
      };
      row.append(yes, no);
      el.append(note, row, status);
    }

    // --- Badge Accro (6 niveaux, descend avec les addictions coch√©es) ---
    function renderAccro(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Coche tes addictions (le niveau commence √† 6 et baisse d‚Äô1 par addiction).';
      const items = [
        {id:'sucre', label:'Sucre'},
        {id:'cafe', label:'Caf√©'},
        {id:'tabac', label:'Tabac'},
        {id:'canabis', label:'Cannabis'},
        {id:'alcool', label:'Alcool'},
        {id:'drogue', label:'Drogue dure'}
      ];
      const list = document.createElement('div');
      list.className = 'list';
      const checks = {};
      items.forEach(t => {
        const row = document.createElement('label');
        row.className = 'row';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = t.id;
        checks[t.id] = input;
        row.append(input, document.createTextNode(t.label));
        list.appendChild(row);
      });
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const count = items.filter(t => checks[t.id].checked).length;
        const lvl = Math.max(0, 6 - count);
        status.innerHTML = `<span class="status ok">Niveau ${lvl} (addictions d√©clar√©es: ${count})</span>`;
        onGain('accro', lvl, { force: true, meta: `${count} addictions` });
      };
      el.append(note, list, btn, status);
    }

    // --- Badge Chanceux (5 niveaux) ---
    function renderChanceux(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Indique tes gains cumul√©s (argent, concours...).';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 1200';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n > 1000) lvl = 5;
        else if (n >= 1000) lvl = 4;
        else if (n >= 500) lvl = 3;
        else if (n >= 100) lvl = 2;
        else if (n >= 20) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} gagn√©s)</span>`;
          onGain('chanceux', lvl, { meta: `${n} gagn√©s` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins au moins 20 pour le niveau 1</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Fanatique (5 niveaux) ---
    function renderFan(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Combien de concerts de musique as-tu d√©j√† faits ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 12';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 100) lvl = 5;
        else if (n >= 50) lvl = 4;
        else if (n >= 20) lvl = 3;
        else if (n >= 10) lvl = 2;
        else if (n >= 5) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} concerts)</span>`;
          onGain('fan', lvl, { meta: `${n} concerts` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 5 concerts pour le niveau 1</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Entrepreneur (1 niveau) ---
    function renderEntrepreneur(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'As-tu d√©j√† mont√© une entreprise / start-up ?';
      const row = document.createElement('div');
      row.className = 'row';
      const yes = document.createElement('button');
      yes.textContent = 'Oui';
      const no = document.createElement('button');
      no.className = 'ghost';
      no.textContent = 'Non';
      const status = document.createElement('div');
      status.className = 'note';
      yes.onclick = () => {
        status.innerHTML = '<span class="status ok">Badge obtenu</span>';
        onGain('entrepreneur', 1, { meta: 'Entreprise cr√©√©e' });
      };
      no.onclick = () => {
        status.innerHTML = '<span class="status ko">Pas encore</span>';
      };
      row.append(yes, no);
      el.append(note, row, status);
    }

    // --- Badge Lecteur (5 niveaux) ---
    function renderLecteur(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Combien de livres as-tu lus ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 45';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 300) lvl = 5;
        else if (n >= 100) lvl = 4;
        else if (n >= 50) lvl = 3;
        else if (n >= 20) lvl = 2;
        else if (n >= 10) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} livres)</span>`;
          onGain('lecteur', lvl, { meta: `${n} livres lus` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 10 livres pour le niveau 1</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Cuisto (1 niveau) ---
    function renderCuisto(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'As-tu d√©j√† cuisin√© pour plus de 10 personnes ?';
      const row = document.createElement('div');
      row.className = 'row';
      const yes = document.createElement('button');
      yes.textContent = 'Oui';
      const no = document.createElement('button');
      no.className = 'ghost';
      no.textContent = 'Non';
      const status = document.createElement('div');
      status.className = 'note';
      yes.onclick = () => {
        status.innerHTML = '<span class="status ok">Badge obtenu</span>';
        onGain('cuisto', 1, { meta: 'Cuisin√© pour 10+ personnes' });
      };
      no.onclick = () => {
        status.innerHTML = '<span class="status ko">Pas encore</span>';
      };
      row.append(yes, no);
      el.append(note, row, status);
    }

    // --- Badge Millionnaire (1 niveau) ---
    function renderMillion(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'As-tu plus de 1 million sur ton compte ?';
      const row = document.createElement('div');
      row.className = 'row';
      const yes = document.createElement('button');
      yes.textContent = 'Oui';
      const no = document.createElement('button');
      no.className = 'ghost';
      no.textContent = 'Non';
      const status = document.createElement('div');
      status.className = 'note';
      yes.onclick = () => {
        status.innerHTML = '<span class="status ok">Badge obtenu</span>';
        onGain('million', 1, { meta: 'Plus de 1M' });
      };
      no.onclick = () => {
        status.innerHTML = '<span class="status ko">Pas encore</span>';
      };
      row.append(yes, no);
      el.append(note, row, status);
    }

    // --- Badge Geek (3 niveaux) ---
    function renderGeek(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Heures pass√©es sur un seul jeu ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 180';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 300) lvl = 3;
        else if (n >= 200) lvl = 2;
        else if (n >= 100) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n}h)</span>`;
          onGain('geek', lvl, { meta: `${n} heures` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 100h pour le niveau 1</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Pilote (7 niveaux cumul√©s) ---
    function renderPilote(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Coche les permis obtenus (ordre cumulatif pour monter de niveau).';
      const items = [
        {id:'scooter', label:'Scooter'},
        {id:'voiture_perm', label:'Voiture'},
        {id:'moto', label:'Moto'},
        {id:'poidslourd', label:'Poids lourd'},
        {id:'agri', label:'Engins agricoles'},
        {id:'bateau_perm', label:'Bateau'},
        {id:'avion_perm', label:'Avion'},
        {id:'chariot', label:'Chariot √©l√©vateur'}
      ];
      const list = document.createElement('div');
      list.className = 'list';
      const checks = {};
      items.forEach(t => {
        const row = document.createElement('label');
        row.className = 'row';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = t.id;
        checks[t.id] = input;
        row.append(input, document.createTextNode(t.label));
        list.appendChild(row);
      });
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const chosen = items.filter(t => checks[t.id].checked).map(t => t.id);
        // Progression cumulative dans cet ordre
        const order = ['scooter','voiture_perm','moto','poidslourd','agri','bateau_perm','avion_perm','chariot'];
        let lvl = 0;
        for (let i = 0; i < order.length; i++) {
          if (chosen.includes(order[i])) {
            lvl++;
          } else {
            break;
          }
        }
        // Limite √† 7 niveaux
        lvl = Math.min(lvl, 7);
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu</span>`;
          onGain('pilote', lvl, { meta: `${chosen.length} permis` });
        } else {
          status.innerHTML = '<span class="status ko">Commence par le permis scooter</span>';
        }
      };
      el.append(note, list, btn, status);
    }

    // --- Badge Killer (2 niveaux) ---
    function renderKiller(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'S√©lectionne ce qui s‚Äôapplique.';
      const row = document.createElement('div');
      row.className = 'row';
      const animal = document.createElement('button');
      animal.textContent = 'Tu√© un animal';
      const humain = document.createElement('button');
      humain.className = 'ghost';
      humain.textContent = 'Tu√© un humain';
      const status = document.createElement('div');
      status.className = 'note';
      animal.onclick = () => {
        status.innerHTML = '<span class="status ok">Niveau 1 obtenu</span>';
        onGain('killer', 1, { meta: 'A tu√© un animal' });
      };
      humain.onclick = () => {
        status.innerHTML = '<span class="status ok">Niveau 2 obtenu</span>';
        onGain('killer', 2, { meta: 'A tu√© un humain' });
      };
      row.append(animal, humain);
      el.append(note, row, status);
    }

    // --- Badge Voleur (4 niveaux) ---
    function renderVoleur(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Montant total vol√© (CHF).';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 600';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 1000) lvl = 4;
        else if (n >= 500) lvl = 3;
        else if (n >= 200) lvl = 2;
        else if (n >= 100) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} CHF)</span>`;
          onGain('voleur', lvl, { meta: `${n} CHF vol√©s` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 100 CHF pour le niveau 1</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Donateur (4 niveaux) ---
    function renderDonateur(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Montant total donn√© √† des associations (CHF).';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 1200';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 100000) lvl = 4;
        else if (n >= 1000) lvl = 3;
        else if (n >= 500) lvl = 2;
        else if (n >= 100) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} CHF)</span>`;
          onGain('donateur', lvl, { meta: `${n} CHF donn√©s` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 100 CHF pour le niveau 1</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Polyglotte (5 niveaux) ---
    function renderPolyglotte(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Combien de langues peux-tu parler ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 3';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 7) lvl = 5;
        else if (n >= 5) lvl = 4;
        else if (n >= 4) lvl = 3;
        else if (n >= 3) lvl = 2;
        else if (n >= 2) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} langues)</span>`;
          onGain('polyglotte', lvl, { meta: `${n} langues` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 2 langues pour le niveau 1</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Cin√©phile (4 niveaux) ---
    function renderCine(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Combien de films as-tu vus ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 120';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 500) lvl = 4;
        else if (n >= 200) lvl = 3;
        else if (n >= 100) lvl = 2;
        else if (n >= 50) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} films)</span>`;
          onGain('cine', lvl, { meta: `${n} films` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 50 films pour le niveau 1</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Randonneur (3 niveaux) ---
    function renderRando(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Combien de sommets ou grandes randonn√©es as-tu faits ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 6';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 10) lvl = 3;
        else if (n >= 5) lvl = 2;
        else if (n >= 1) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} sommets)</span>`;
          onGain('rando', lvl, { meta: `${n} sommets` });
        } else {
          status.innerHTML = '<span class="status ko">Fais au moins 1 sommet pour commencer</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Codeur (5 niveaux) ---
    function renderCodeur(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Heures de code cumul√©es ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 250';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 2000) lvl = 5;
        else if (n >= 1000) lvl = 4;
        else if (n >= 500) lvl = 3;
        else if (n >= 100) lvl = 2;
        else if (n >= 20) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} h)</span>`;
          onGain('codeur', lvl, { meta: `${n} heures de code` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 20 h pour le niveau 1</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Jardinier (3 niveaux) ---
    function renderJardinier(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Combien de plantes as-tu fait pousser (potager/fleurs) ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 12';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 20) lvl = 3;
        else if (n >= 10) lvl = 2;
        else if (n >= 3) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} plantes)</span>`;
          onGain('jardinier', lvl, { meta: `${n} plantes` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 3 plantes pour commencer</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Marathonien (4 niveaux) ---
    function renderMarathon(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Quelle est ta plus longue course (km) ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 21';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 42) lvl = 4;
        else if (n >= 21) lvl = 3;
        else if (n >= 10) lvl = 2;
        else if (n >= 5) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} km)</span>`;
          onGain('marathon', lvl, { meta: `${n} km` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 5 km pour commencer</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Photographe (2 niveaux) ---
    function renderPhoto(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Coche ce qui s‚Äôapplique.';
      const row = document.createElement('div');
      row.className = 'row';
      const shot = document.createElement('button');
      shot.textContent = 'J‚Äôai shoot√© une photo';
      const sold = document.createElement('button');
      sold.className = 'ghost';
      sold.textContent = 'J‚Äôai vendu une photo';
      const status = document.createElement('div');
      status.className = 'note';
      shot.onclick = () => {
        status.innerHTML = '<span class="status ok">Niveau 1 obtenu</span>';
        onGain('photo', 1, { meta: 'Photo r√©alis√©e' });
      };
      sold.onclick = () => {
        status.innerHTML = '<span class="status ok">Niveau 2 obtenu</span>';
        onGain('photo', 2, { meta: 'Photo vendue' });
      };
      row.append(shot, sold);
      el.append(note, row, status);
    }

    // --- Badge Brasseur (3 niveaux) ---
    function renderBrasseur(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Combien de bi√®res diff√©rentes as-tu d√©gust√©es ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 18';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 50) lvl = 3;
        else if (n >= 20) lvl = 2;
        else if (n >= 5) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} bi√®res)</span>`;
          onGain('brasseur', lvl, { meta: `${n} bi√®res` });
        } else {
          status.innerHTML = '<span class="status ko">D√©guste au moins 5 bi√®res diff√©rentes pour commencer</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Parachutiste (2 niveaux) ---
    function renderParachute(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Combien de sauts en parachute as-tu faits ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 2';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 5) lvl = 2;
        else if (n >= 1) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} sauts)</span>`;
          onGain('parachute', lvl, { meta: `${n} sauts` });
        } else {
          status.innerHTML = '<span class="status ko">Fais au moins 1 saut pour commencer</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Astronome (4 niveaux) ---
    function renderAstro(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Nuits d‚Äôobservation (jumelles/t√©lescope/oeil nu) ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 15';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 100) lvl = 4;
        else if (n >= 50) lvl = 3;
        else if (n >= 20) lvl = 2;
        else if (n >= 5) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} nuits)</span>`;
          onGain('astro', lvl, { meta: `${n} nuits` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 5 nuits pour commencer</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Volontaire (3 niveaux) ---
    function renderVolontaire(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Heures de b√©n√©volat r√©alis√©es ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 30';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 200) lvl = 3;
        else if (n >= 50) lvl = 2;
        else if (n >= 5) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} h)</span>`;
          onGain('volontaire', lvl, { meta: `${n} h b√©n√©volat` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 5 h pour commencer</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge DJ (3 niveaux) ---
    function renderDJ(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Combien de sets ou mixes as-tu jou√©s ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 12';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 50) lvl = 3;
        else if (n >= 10) lvl = 2;
        else if (n >= 1) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} mixes)</span>`;
          onGain('dj', lvl, { meta: `${n} mixes` });
        } else {
          status.innerHTML = '<span class="status ko">Joue au moins 1 set pour commencer</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Gourmet (4 niveaux) ---
    function renderGourmet(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Restaurants √©toil√©s d√©j√† visit√©s ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 4';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 10) lvl = 4;
        else if (n >= 5) lvl = 3;
        else if (n >= 3) lvl = 2;
        else if (n >= 1) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} restos)</span>`;
          onGain('gourmet', lvl, { meta: `${n} restos √©toil√©s` });
        } else {
          status.innerHTML = '<span class="status ko">Visite au moins 1 resto √©toil√© pour commencer</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Contact (5 niveaux) ---
    function renderContact(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Combien de contacts as-tu dans ton t√©l√©phone ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 220';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n >= 1000) lvl = 5;
        else if (n >= 500) lvl = 4;
        else if (n >= 300) lvl = 3;
        else if (n >= 150) lvl = 2;
        else if (n >= 50) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} contacts)</span>`;
          onGain('contact', lvl, { meta: `${n} contacts` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 50 contacts pour commencer</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Sauveteur (1 niveau) ---
    function renderSauveteur(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'As-tu d√©j√† secouru une vie (secours, sauvetage) ?';
      const row = document.createElement('div');
      row.className = 'row';
      const yes = document.createElement('button');
      yes.textContent = 'Oui';
      const no = document.createElement('button');
      no.className = 'ghost';
      no.textContent = 'Non';
      const status = document.createElement('div');
      status.className = 'note';
      yes.onclick = () => {
        status.innerHTML = '<span class="status ok">Badge obtenu</span>';
        onGain('sauveteur', 1, { meta: 'Une vie secourue' });
      };
      no.onclick = () => {
        status.innerHTML = '<span class="status ko">Pas encore</span>';
      };
      row.append(yes, no);
      el.append(note, row, status);
    }


    // --- Badge Fou du volant (4 niveaux) ---
    function renderFouVolant(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Vitesse max atteinte sur autoroute (km/h).';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 210';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n > 300) lvl = 4;
        else if (n > 250) lvl = 3;
        else if (n > 200) lvl = 2;
        else if (n > 150) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} km/h)</span>`;
          onGain('fou', lvl, { meta: `${n} km/h` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins plus de 150 km/h pour le niveau 1</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Artiste Peintre (2 niveaux) ---
    function renderPeintre(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Coche ce qui s‚Äôapplique.';
      const row = document.createElement('div');
      row.className = 'row';
      const painted = document.createElement('button');
      painted.textContent = 'J‚Äôai peint un tableau';
      const sold = document.createElement('button');
      sold.className = 'ghost';
      sold.textContent = 'J‚Äôai vendu un tableau';
      const status = document.createElement('div');
      status.className = 'note';
      painted.onclick = () => {
        status.innerHTML = '<span class="status ok">Niveau 1 obtenu</span>';
        onGain('peintre', 1, { meta: 'Tableau peint' });
      };
      sold.onclick = () => {
        status.innerHTML = '<span class="status ok">Niveau 2 obtenu</span>';
        onGain('peintre', 2, { meta: 'Tableau vendu' });
      };
      row.append(painted, sold);
      el.append(note, row, status);
    }

    // --- Badge Magnat (4 niveaux) ---
    function renderMagnat(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Montant sur ton compte (CHF).';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 120000';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n > 500000) lvl = 4;
        else if (n >= 100000) lvl = 3;
        else if (n >= 50000) lvl = 2;
        else if (n >= 10000) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} CHF)</span>`;
          onGain('magnat', lvl, { meta: `${n} CHF` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins 10‚Äô000 CHF pour le niveau 1</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Kamasutra (4 niveaux) ---
    function renderKama(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Nombre de positions diff√©rentes pratiqu√©es ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 8';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n > 20) lvl = 4;
        else if (n > 10) lvl = 3;
        else if (n > 5) lvl = 2;
        else if (n > 3) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} positions)</span>`;
          onGain('kama', lvl, { meta: `${n} positions` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins plus de 3 positions pour le niveau 1</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Bodycounter (6 niveaux) ---
    function renderBody(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'Nombre total de partenaires ?';
      const input = document.createElement('input');
      input.type = 'number';
      input.placeholder = 'Ex: 12';
      const btn = document.createElement('button');
      btn.textContent = 'Valider';
      const status = document.createElement('div');
      status.className = 'note';
      btn.onclick = () => {
        const n = Number(input.value);
        if (isNaN(n) || n < 0) {
          status.innerHTML = '<span class="status ko">Indique un nombre valide</span>';
          return;
        }
        let lvl = 0;
        if (n > 50) lvl = 6;
        else if (n > 40) lvl = 5;
        else if (n > 30) lvl = 4;
        else if (n > 20) lvl = 3;
        else if (n > 10) lvl = 2;
        else if (n > 5) lvl = 1;
        if (lvl > 0) {
          status.innerHTML = `<span class="status ok">Niveau ${lvl} obtenu (${n} partenaires)</span>`;
          onGain('body', lvl, { meta: `${n} partenaires` });
        } else {
          status.innerHTML = '<span class="status ko">Atteins plus de 5 partenaires pour le niveau 1</span>';
        }
      };
      el.append(note, input, btn, status);
    }

    // --- Badge Musicien (1 niveau) ---
    function renderMusicien(el, level, onGain) {
      const note = document.createElement('p');
      note.className = 'note';
      note.textContent = 'As-tu compos√© une musique ?';
      const row = document.createElement('div');
      row.className = 'row';
      const yes = document.createElement('button');
      yes.textContent = 'Oui';
      const no = document.createElement('button');
      no.className = 'ghost';
      no.textContent = 'Non';
      const status = document.createElement('div');
      status.className = 'note';
      yes.onclick = () => {
        status.innerHTML = '<span class="status ok">Badge obtenu</span>';
        onGain('musicien', 1, { meta: 'Une musique compos√©e' });
      };
      no.onclick = () => {
        status.innerHTML = '<span class="status ko">Pas encore</span>';
      };
      row.append(yes, no);
      el.append(note, row, status);
    }

    // --- Initialisation ---
    loadProfileSingle();

    setupToggle(toggleMy, myBody, mySection);
    setupToggle(toggleAll, allBody, allSection);

    resetBtn.onclick = () => {
      state.name = '';
      state.firstName = '';
      state.lastName = '';
      state.owned = {};
      state.answers = {};
      nameDisplay.textContent = 'Profil non d√©fini';
      refreshHello();
      renderOwned();
      renderAll();
      persist();
    };

    loginBtn.onclick = () => {
      loginForm.classList.remove('hidden');
      regForm.classList.add('hidden');
    };

    registerBtn.onclick = () => {
      regForm.classList.remove('hidden');
      loginForm.classList.add('hidden');
    };

    logoutBtn.onclick = async () => {
      await supabaseClient.auth.signOut();
      state.started = false;
      state.currentUser = '';
      saveProfiles();
      updateVisibility();
    };

    loginSubmit.onclick = async () => {
      const u = loginUser.value.trim();
      const p = loginPass.value.trim();
      if (!u || !p) { alert('Renseigne utilisateur et mot de passe'); return; }
      const email = `${u}@badgelife.local`;
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: p });
      if (error || !data.session) { alert('Identifiants incorrects'); return; }
      const uid = data.session.user.id;
      state.currentUser = uid;
      const local = state.profiles.find(x => x.user === uid);
      if (local) {
        applyProfile(local);
      } else {
        applyProfile({ user: uid, name: data.session.user.user_metadata?.name || u, firstName: u, lastName: '' , owned:{}, answers:{} });
      }
      state.started = true;
      persist();
      refreshHello();
      renderOwned();
      renderAll();
      updateVisibility();
      loginForm.classList.add('hidden');
    };

    regSubmit.onclick = async () => {
      const u = regUser.value.trim();
      const f = regFirst.value.trim();
      const l = regLast.value.trim();
      const p = regPass.value.trim();
      if (!u || !f || !l || !p) {
        alert('Renseigne utilisateur, pr√©nom, nom et mot de passe.');
        return;
      }
      const email = `${u}@badgelife.local`;
      const { data, error } = await supabaseClient.auth.signUp({
        email,
        password: p,
        options: { data: { username: u, first_name: f, last_name: l, name: `${f} ${l}` } }
      });
      if (error || !data.session) {
        alert(error?.message || 'Erreur √† l‚Äôinscription');
        return;
      }
      const uid = data.session.user.id;
      const profile = {
        user: uid,
        name: `${f} ${l}`,
        firstName: f,
        lastName: l,
        owned: {},
        answers: {}
      };
      state.profiles.push(profile);
      state.currentUser = uid;
      applyProfile(profile);
      state.started = true;
      persist();
      refreshHello();
      renderOwned();
      renderAll();
      updateVisibility();
      regForm.classList.add('hidden');
    };

    // Tabs navigation
    tabButtons.forEach(btn => {
      btn.onclick = () => {
        const target = btn.getAttribute('data-tab');
        tabButtons.forEach(b => b.classList.toggle('active', b === btn));
        tabPanels.forEach(p => p.classList.toggle('active', p.id === target));
      };
    });

    // Service worker registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    }

    // R√©cup√©ration session Supabase au chargement
    (async () => {
      const { data: { session } } = await supabaseClient.auth.getSession();
      loadProfiles();
      if (session?.user?.id) {
        state.currentUser = session.user.id;
        const local = state.profiles.find(x => x.user === state.currentUser);
        if (local) {
          applyProfile(local);
        } else {
          applyProfile({
            user: state.currentUser,
            name: session.user.user_metadata?.name || 'Profil',
            firstName: session.user.user_metadata?.first_name || '',
            lastName: session.user.user_metadata?.last_name || '',
            owned: {},
            answers: {}
          });
        }
        state.started = true;
      }
      refreshHello();
      renderOwned();
      renderAll();
      updateVisibility();
    })();
  </script>
</body>
</html>

